package main

import (
	"bytes"
	"encoding/base64"
	"fmt"
	"github.com/otiai10/gosseract"
	"image/png"
	"io/ioutil"
	"net/http"
	"os"
	"strings"
)

func main() {
	for i := 1; i <= 1000; i++ {
		fmt.Println("Attempt", i, "....")

		url := "http://challenge01.root-me.org/programmation/ch8/"
		req, _ := http.NewRequest("GET", url, nil)
		res, _ := http.DefaultClient.Do(req)
	
		defer res.Body.Close()
		var mycookie string
		for _, cookie := range res.Cookies() {
			mycookie = cookie.Value
		}

		body, _ := ioutil.ReadAll(res.Body)
		resp := string(body)
		arr := strings.Split(resp, ",")
		resp = arr[1]
		b := ""

		for _, j := range resp {
			if j != '"' {
				b += string(j)
			}
			if j == '"' {
				break
			}
		}
	
		unbased, err := base64.StdEncoding.DecodeString(b)
		if err != nil {
			panic("Cannot decode b64")
		}
	
		r := bytes.NewReader(unbased)
		im, err := png.Decode(r)
		if err != nil {
			panic("Bad png")
		}
	
		f, err := os.OpenFile("example.png", os.O_WRONLY|os.O_CREATE, 0777)
		if err != nil {
			panic("Cannot open file")
		}
	
		png.Encode(f, im)
		client := gosseract.NewClient()
		defer client.Close()
		client.SetImage("example.png")
		text, _ := client.Text()
	
		if 0 < 1 {
			url := "http://challenge01.root-me.org/programmation/ch8/" 
			postData := "cametu=" + text
			req, _ := http.NewRequest("POST", url, bytes.NewBufferString(postData))
			req.Header.Set("Cookie", "PHPSESSID="+mycookie+";")
			req.Header.Set("Content-Type", "application/x-www-form-urlencoded")
			res, _ := http.DefaultClient.Do(req)
			defer res.Body.Close()
			body, _ := ioutil.ReadAll(res.Body)
			resp := string(body)
			if !strings.Contains(resp, "retente ta chance") {
				fmt.Println("LOOKS LIKE I FOUND SOMETHING!", resp)
				os.Exit(1)
			}
		}
	}
	
}
