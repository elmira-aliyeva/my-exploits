package main

import (
	"bufio"
	"fmt"
	"net"
	"os"
	"os/exec"
	"strings"
)

func GetResponse(c net.Conn) string {
	resp := ""
	connbuf := bufio.NewReader(c)
	b, _ := connbuf.ReadByte()
	if connbuf.Buffered() > 0 {
		var msgData []byte
		msgData = append(msgData, b)
		for connbuf.Buffered() > 0 {
			b, err := connbuf.ReadByte()
			if err == nil {
				msgData = append(msgData, b)
			}
		}
		resp = string(msgData)
	}
	return resp
}

func ZlibDecode(cmd string) string {
	output, err := exec.Command("bash", "-c", cmd).CombinedOutput()
	if err != nil {
		os.Stderr.WriteString(err.Error())
	}
	return string(output)
}

func main() {
	c, _ := net.Dial("tcp", "irc.root-me.org:6667")
	text := []string{"PASS none\n", "NICK Bunn\n", "USER Bunn ircip1.mibbit.com ircip1.mibbit.com Bunn\n", "\n", "privmsg candy !ep4\n", "\n"}
	resp := ""
	for _, j := range text {
		fmt.Println("Sending this message: ", j)
		fmt.Fprintf(c, j)
		resp = GetResponse(c)
		fmt.Println("Response: ", resp)
		if strings.Contains(resp, ":Candy!Candy@root-me.org") {
			arr := strings.Split(resp, ":")
			for i, j := range arr {
				if i == len(arr)-1 {
					data := ""
					for _, k := range j {
						if k != '\n' && k != '\r' {
							data += string(k)
						}
					}
					cmd := "echo " + data + " | base64 --decode | perl -e 'use Compress::Raw::Zlib;my $d=new Compress::Raw::Zlib::Inflate();my $o;undef $/;$d->inflate(<>,$o);print $o;'"
					fmt.Println(cmd)
					ans := "privmsg candy !ep4 -rep " + ZlibDecode(cmd) + "\r\n"
					fmt.Println("Sending this message: ", ans)
					fmt.Fprintf(c, ans)
					resp2 := GetResponse(c)
					fmt.Println("Response: ", resp2)
				}
			}

		}
	}
}
